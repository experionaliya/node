var express=require("express");
var app=express();
var fs=require("fs");
var __=require("lodash");
var user = {
   "user2" : {
      "name" : "xyz",
      "age" : 10
     
   }
}

//fetching all the data using get
var personRouter=express.Router();
personRouter.route('/fetch')
.get( function(request, response) {
 
    response.contentType('application/json');
    fs.readFile('people.json','utf8',function (err,data){
      if (err) {
        return console.log("error");
      }
      else{
       
        var person=JSON.parse( data );
  	response.send(person);
       
      }
    });
});


//fetching details of a particular user
personRouter.route('/:username')
.get(function(request, response) {
 
  response.contentType('application/json');
  fs.readFile('people.json','utf8',function (err,data){
    if (err) {
      return console.log("error");
    }
    else{
      
      var person=JSON.parse(data);
	console.log(request.params.username);
	response.send(__.find(person,{"name":request.params.username}));
	 }
    });
});

//deleting a particular user entry
personRouter.route('/delete/:username')
.get(function(request, response) {
 
  response.contentType('application/json');
  fs.readFile('people.json','utf8',function (err,data){
          if (err) {
            return console.log("error");
          }
          else{
      
            var person=JSON.parse( data );
            var name=__.find(person,{"name":request.params.username});
            console.log(name);
            __.remove(person,name);
               person = JSON.stringify(person);
                fs.writeFile("people.json", person, function(err) {
                  if(err) {
                    return console.log(err);
                  }
                  else{

                console.log("The file is updated");
              }
             });
          }

      });
});
     

//adding a new entry
personRouter.route('/add')
.post(function(request, response) {
 
  response.contentType('application/json');
  fs.readFile('people.json','utf8',function (err,data){
	    if (err) {
	      return console.log("error");
	    }
	    else{
	      
	      var person=JSON.parse(data);
		
		person.push(user["user2"]);
		person=JSON.stringify(person);
		console.log(person);
	     	fs.writeFile("people.json", person, function(err) {
		    if(err) {
			return console.log(err);
		    }
		    else{
	    		console.log("New entry made");
		    }
		}); 
	
	    }
  });
});

app.use('/',personRouter);
app.listen(8081, function(){
  console.log("server started");
});


